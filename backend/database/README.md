# EventCraft Database Setup

This directory contains the database schema and setup files for the EventCraft platform.

## Quick Setup

### 1. Run the Schema
1. Go to your [Supabase Dashboard](https://supabase.com/dashboard)
2. Select your project
3. Go to **SQL Editor**
4. Copy and paste the contents of `schema.sql`
5. Click **Run**

### 2. Verify Setup
After running the schema, you should have:
- ✅ All tables created (users, providers, events, tasks, leads, provider_views)
- ✅ Row Level Security enabled
- ✅ Auto-user creation trigger active
- ✅ Storage bucket configured

### 3. Test Auto-User Creation
1. Sign out of your application
2. Sign back in with Google OAuth
3. Check the `users` table - your record should be automatically created
4. No more PGRST116 errors!

## Database Schema Overview

### Core Tables

#### `users`
- Stores user profiles for all platform users
- Automatically populated via trigger when users sign up
- Links to Supabase Auth via UUID

#### `providers`
- Business/service provider information
- Linked to users table via `user_id`
- Contains business details, location, subscription status

#### `events`
- User's event planning sessions
- Stores event type, AI prompts, generated checklists
- One-to-many relationship with tasks

#### `tasks`
- Individual planning steps/tasks within events
- Generated by AI based on event requirements
- Contains matching provider recommendations

#### `leads`
- Inquiries/contacts from users to providers
- Tracks communication and booking status
- Analytics for providers

#### `provider_views`
- Analytics tracking for provider visibility
- Helps providers understand their reach

### Key Features

#### Auto User Creation
- **Trigger**: `on_auth_user_created`
- **Function**: `handle_new_user()`
- Automatically creates user records when someone signs up via any method (OAuth, email/password)
- Uses actual user data from OAuth metadata

#### Row Level Security (RLS)
- All tables have comprehensive security policies
- Users can only access their own data
- Providers can view their own analytics and leads
- Public can view active providers

#### File Storage
- Configured `uploads` bucket for logos, images
- Proper access policies for authenticated users

## Troubleshooting

### PGRST116 Errors
This error means "user record not found". After running this schema, the trigger should automatically create user records, eliminating this error.

### Permission Denied Errors
Check that RLS policies are properly set up. The schema includes comprehensive policies for all use cases.

### OAuth Issues
The trigger extracts user information from `raw_user_meta_data` which includes:
- `full_name` from OAuth providers (Google, etc.)
- Email address
- Other provider-specific metadata

## Schema Updates

To modify the schema:
1. Make changes to `schema.sql`
2. Test in a development Supabase project first
3. Run migrations carefully in production
4. Update this README with any changes

## Environment Variables

Ensure your frontend has these environment variables:
```env
VITE_SUPABASE_URL=https://your-project-ref.supabase.co
VITE_SUPABASE_ANON_KEY=your-supabase-anon-key
```

## Support

If you encounter issues:
1. Check Supabase logs in the dashboard
2. Verify all tables were created successfully
3. Test the trigger by creating a new user
4. Check RLS policies are active

The schema is designed to be comprehensive and production-ready with proper security, relationships, and automation.